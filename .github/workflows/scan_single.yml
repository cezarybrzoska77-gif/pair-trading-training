name: Scan Pairs Single Basket

on:
  schedule:
    - cron: '0 22 * * *'  # Daily at 22:00 UTC
  workflow_dispatch:  # Manual trigger

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create data directory
      run: mkdir -p data
    
    - name: Create results directory
      run: mkdir -p results/discretionary
    
    - name: Create state directory
      run: mkdir -p state
    
    - name: Download previous state (if exists)
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: discretionary-history-state
        path: state/
    
    - name: Run scanner
      run: |
        python scan_pairs_single.py \
          --tickers-file data/tickers_discretionary.txt \
          --start-date 2018-01-01 \
          --auto-adjust \
          --coint-lookbacks 240,300 \
          --min-sample 200 \
          --topk 100 \
          --out-dir results/discretionary
    
    - name: Run stabilization
      run: |
        python run_and_stabilize.py \
          --in-csv results/discretionary/discretionary_candidates.csv \
          --state state/discretionary_history.csv \
          --out-dir results/discretionary
    
    - name: Upload all metrics CSV
      uses: actions/upload-artifact@v4
      with:
        name: discretionary-all-metrics
        path: results/discretionary/discretionary_all_metrics.csv
        retention-days: 30
    
    - name: Upload candidates CSV
      uses: actions/upload-artifact@v4
      with:
        name: discretionary-candidates
        path: results/discretionary/discretionary_candidates.csv
        retention-days: 30
    
    - name: Upload stable pairs CSV
      uses: actions/upload-artifact@v4
      with:
        name: discretionary-stable-pairs
        path: results/discretionary/discretionary_stable.csv
        retention-days: 30
    
    - name: Upload new candidates CSV
      uses: actions/upload-artifact@v4
      with:
        name: discretionary-new-candidates
        path: results/discretionary/new_candidates.csv
        retention-days: 30
    
    - name: Upload dropped pairs CSV
      uses: actions/upload-artifact@v4
      with:
        name: discretionary-dropped-pairs
        path: results/discretionary/dropped_pairs.csv
        retention-days: 30
    
    - name: Upload history state
      uses: actions/upload-artifact@v4
      with:
        name: discretionary-history-state
        path: state/discretionary_history.csv
        retention-days: 90