name: Workflow 1 - Pairs Screening

on:
  schedule:
    # Daily at 22:00 UTC (after market close)
    - cron: '0 22 * * *'
  
  workflow_dispatch:
    # Manual trigger with optional universe selection
    inputs:
      universe:
        description: 'Universe to scan (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - tech_core
          - semis
          - software
          - financials
          - healthcare
          - discretionary

jobs:
  # ==========================================================================
  # SCREENING JOBS (Matrix)
  # ==========================================================================
  screen-universes:
    name: Screen ${{ matrix.universe }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        universe:
          - tech_core
          - semis
          - software
          - financials
          - healthcare
          - discretionary
    
    # Skip if manual trigger with specific universe selected
    if: |
      github.event_name == 'schedule' || 
      github.event.inputs.universe == '' || 
      github.event.inputs.universe == matrix.universe
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run screening for ${{ matrix.universe }}
        run: |
          python scan_pairs_multi.py ${{ matrix.universe }}
      
      - name: Upload universe results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.universe }}
          path: results/${{ matrix.universe }}/
          retention-days: 30
  
  # ==========================================================================
  # AGGREGATION JOB
  # ==========================================================================
  aggregate-and-stabilize:
    name: Aggregate & Stabilize
    runs-on: ubuntu-latest
    needs: screen-universes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download all universe results
        uses: actions/download-artifact@v4
        with:
          path: results/
      
      - name: Reorganize downloaded artifacts
        run: |
          # Move artifacts from artifact folders to universe folders
          for universe in tech_core semis software financials healthcare discretionary; do
            if [ -d "results/results-${universe}" ]; then
              mkdir -p "results/${universe}"
              mv results/results-${universe}/* "results/${universe}/" || true
              rm -rf "results/results-${universe}"
            fi
          done
      
      - name: Download persistence history
        uses: actions/download-artifact@v4
        with:
          name: persistence-history
          path: results/
        continue-on-error: true
      
      - name: Run aggregation & stabilization
        run: |
          python run_all_and_aggregate_stable.py
      
      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: combined-results
          path: |
            results/combined_pairs_scored.csv
            results/combined_top150_watchlist.csv
            results/new_candidates.csv
            results/dropped_pairs.csv
          retention-days: 90
      
      - name: Upload persistence history
        uses: actions/upload-artifact@v4
        with:
          name: persistence-history
          path: results/persistence_history.csv
          retention-days: 365
      
      - name: Upload stable lists
        uses: actions/upload-artifact@v4
        with:
          name: stable-lists
          path: results/**/\*_stable.csv
          retention-days: 30
      
      - name: Generate summary
        run: |
          echo "# Workflow 1 Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "results/combined_top150_watchlist.csv" ]; then
            WATCHLIST_COUNT=$(tail -n +2 results/combined_top150_watchlist.csv | wc -l)
            echo "âœ… **TOP 150 Watchlist:** ${WATCHLIST_COUNT} pairs" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "results/new_candidates.csv" ]; then
            NEW_COUNT=$(tail -n +2 results/new_candidates.csv | wc -l)
            echo "ðŸ†• **New Candidates:** ${NEW_COUNT} pairs" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "results/dropped_pairs.csv" ]; then
            DROP_COUNT=$(tail -n +2 results/dropped_pairs.csv | wc -l)
            echo "ðŸ“‰ **Dropped Pairs:** ${DROP_COUNT} pairs" >> $GITHUB_STEP_SUMMARY
          fi