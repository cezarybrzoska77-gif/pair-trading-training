name: Workflow 1 - Pairs Screening

on:
  schedule:
    # Codziennie o 22:00 UTC
    - cron: '0 22 * * *'
  workflow_dispatch:
    # Manualne uruchomienie

jobs:
  screen_pairs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        universe:
          - tech_core
          - semis
          - software
          - financials
          - healthcare
          - discretionary
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas scipy scikit-learn statsmodels yfinance
      
      - name: Run screening for ${{ matrix.universe }}
        run: |
          python scan_pairs_multi.py --universe ${{ matrix.universe }} --lookback 365 --min_sample 200
      
      - name: Upload results for ${{ matrix.universe }}
        uses: actions/upload-artifact@v3
        with:
          name: results-${{ matrix.universe }}
          path: results/${{ matrix.universe }}/
          retention-days: 30
      
      - name: Upload persistence tracking
        uses: actions/upload-artifact@v3
        with:
          name: persistence-${{ matrix.universe }}
          path: results/persistence/
          retention-days: 90

  aggregate_and_generate:
    runs-on: ubuntu-latest
    needs: screen_pairs
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: results/
      
      - name: Run aggregator
        run: |
          python run_all_and_aggregate_stable.py
      
      - name: Upload combined results
        uses: actions/upload-artifact@v3
        with:
          name: combined-results
          path: |
            results/combined_pairs_scored.csv
            results/combined_top150_watchlist.csv
            results/new_candidates.csv
            results/dropped_pairs.csv
          retention-days: 90
      
      - name: Commit and push results (optional)
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add results/
          git commit -m "Auto-update: Workflow 1 screening results $(date +%Y-%m-%d)" || echo "No changes to commit"
          git push || echo "Nothing to push"