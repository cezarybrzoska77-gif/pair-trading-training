name: Workflow 1 - Pairs Screening

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  screen_pairs:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        universe:
          - tech_core
          - semis
          - software
          - financials
          - healthcare
          - discretionary
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify ticker files exist
        run: |
          echo "=== Checking for ticker files ==="
          ls -lah data/
          if [ ! -f "data/tickers_${{ matrix.universe }}.txt" ]; then
            echo "ERROR: data/tickers_${{ matrix.universe }}.txt NOT FOUND"
            exit 1
          fi
          echo "âœ“ Ticker file found for ${{ matrix.universe }}"
          head -5 data/tickers_${{ matrix.universe }}.txt
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create results directory structure
        run: |
          mkdir -p results/${{ matrix.universe }}
          mkdir -p results/persistence
      
      - name: Run screening for ${{ matrix.universe }}
        run: |
          python scan_pairs_multi.py --universe ${{ matrix.universe }} --lookback 365 --min_sample 200
      
      - name: Verify outputs
        run: |
          echo "=== Checking outputs ==="
          ls -lah results/${{ matrix.universe }}/ || echo "No universe directory"
          ls -lah results/persistence/ || echo "No persistence directory"
      
      - name: Upload results for ${{ matrix.universe }}
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.universe }}
          path: results/${{ matrix.universe }}/
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload persistence tracking
        uses: actions/upload-artifact@v4
        with:
          name: persistence-${{ matrix.universe }}
          path: results/persistence/${{ matrix.universe }}_persistence.csv
          retention-days: 90
          if-no-files-found: warn

  aggregate_and_generate:
    runs-on: ubuntu-latest
    needs: screen_pairs
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas
      
      - name: Create results directory structure
        run: |
          mkdir -p results
          mkdir -p results/persistence
      
      - name: Download all universe results
        uses: actions/download-artifact@v4
        with:
          pattern: results-*
          path: results/
          merge-multiple: true
        continue-on-error: true
      
      - name: Download all persistence files
        uses: actions/download-artifact@v4
        with:
          pattern: persistence-*
          path: results/persistence/
          merge-multiple: true
        continue-on-error: true
      
      - name: List downloaded files
        run: |
          echo "=== Results directory structure ==="
          find results -type f -name "*.csv" 2>/dev/null | head -30 || echo "No CSV files found"
          echo "=== Persistence directory ==="
          ls -lah results/persistence/ || echo "No persistence files"
      
      - name: Run aggregator
        run: |
          python run_all_and_aggregate_stable.py
        continue-on-error: true
      
      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: combined-results
          path: |
            results/combined_pairs_scored.csv
            results/combined_top150_watchlist.csv
            results/new_candidates.csv
            results/dropped_pairs.csv
          retention-days: 90
          if-no-files-found: warn
      
      - name: Generate summary report
        run: |
          echo "## Workflow 1 Screening Summary" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f results/combined_pairs_scored.csv ]; then
            TOTAL_PAIRS=$(tail -n +2 results/combined_pairs_scored.csv | wc -l)
            echo "âœ… **Total Candidate Pairs**: $TOTAL_PAIRS" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **No combined results generated**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f results/combined_top150_watchlist.csv ]; then
            TOP_PAIRS=$(tail -n +2 results/combined_top150_watchlist.csv | wc -l)
            echo "âœ… **Top Watchlist Pairs**: $TOP_PAIRS" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f results/new_candidates.csv ]; then
            NEW_PAIRS=$(tail -n +2 results/new_candidates.csv | wc -l)
            echo "ðŸ†• **New Candidates**: $NEW_PAIRS" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f results/dropped_pairs.csv ]; then
            DROPPED_PAIRS=$(tail -n +2 results/dropped_pairs.csv | wc -l)
            echo "â¬‡ï¸ **Dropped Pairs**: $DROPPED_PAIRS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Universe Breakdown" >> $GITHUB_STEP_SUMMARY
          for univ in tech_core semis software financials healthcare discretionary; do
            if [ -f results/$univ/${univ}_candidates.csv ]; then
              COUNT=$(tail -n +2 results/$univ/${univ}_candidates.csv | wc -l)
              echo "- **$univ**: $COUNT candidates" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **$univ**: âŒ No results" >> $GITHUB_STEP_SUMMARY
            fi
          done